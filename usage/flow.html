<!DOCTYPE html>
<html class="no-js" lang="en">

<head>
<title>Flow API · Blindsight</title>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<meta name="description" content='docs'/>
<link rel="canonical" href="/blindsight/usage/flow.html"/>
<link href="https://fonts.googleapis.com/css?family=Roboto:100normal,100italic,300normal,300italic,400normal,400italic,500normal,500italic,700normal,700italic,900normal,900italicc" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../lib/jquery/jquery.min.js"></script>
<script type="text/javascript" src="../js/page.js"></script>
<script type="text/javascript" src="../js/warnOldVersion.js"></script>
<script type="text/javascript" src="../js/groups.js"></script>
<link rel="stylesheet" type="text/css" href="../lib/foundation/dist/foundation.min.css"/>
<link rel="stylesheet" type="text/css" href="../css/page.css"/>

<!--
<link rel="shortcut icon" href="../images/favicon.ico" />
-->
</head>

<body>
<div class="off-canvas-wrapper">
<div class="off-canvas-wrapper-inner" data-off-canvas-wrapper>

<div class="off-canvas position-left" id="off-canvas-menu" data-off-canvas>
<nav class="off-canvas-nav">
<div class="nav-home">
<a href="../index.html" >
<span class="home-icon">⌂</span>Blindsight
</a>
<div class="version-number">
0.1.35
</div>
</div>
<div class="nav-toc">
<ul>
  <li><a href="../setup/index.html" class="page">Setup</a>
  <ul>
    <li><a href="../setup/logback.html" class="page">Logback</a></li>
    <li><a href="../setup/generic.html" class="page">Generic</a></li>
  </ul></li>
  <li><a href="../usage/index.html" class="page">Usage</a>
  <ul>
    <li><a href="../usage/overview.html" class="page">Overview</a></li>
    <li><a href="../usage/resolvers.html" class="page">Logger Resolvers</a></li>
    <li><a href="../usage/slf4j.html" class="page">SLF4J API</a></li>
    <li><a href="../usage/fluent.html" class="page">Fluent API</a></li>
    <li><a href="../usage/semantic.html" class="page">Semantic API</a></li>
    <li><a href="../usage/flow.html" class="active page">Flow API</a></li>
    <li><a href="../usage/structured.html" class="page">Structured Logging</a></li>
    <li><a href="../usage/conditional.html" class="page">Conditional Logging</a></li>
    <li><a href="../usage/context.html" class="page">Contextual Logging</a></li>
    <li><a href="../usage/sourcecode.html" class="page">Source Code</a></li>
  </ul></li>
  <li><a href="../extending/index.html" class="page">Extending</a>
  <ul>
    <li><a href="../extending/overview.html" class="page">Overview</a></li>
  </ul></li>
</ul>
</div>

</nav>
</div>

<div class="off-canvas-content" data-off-canvas-content>

<header class="site-header expanded row">
<div class="small-12 column">
<a href="#" class="off-canvas-toggle hide-for-medium" data-toggle="off-canvas-menu"><svg class="svg-icon svg-icon-menu" version="1.1" id="Menu" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" viewBox="0 0 20 20" enable-background="new 0 0 20 20" xml:space="preserve"> <path class="svg-icon-menu-path" fill="#53CDEC" d="M16.4,9H3.6C3.048,9,3,9.447,3,10c0,0.553,0.048,1,0.6,1H16.4c0.552,0,0.6-0.447,0.6-1C17,9.447,16.952,9,16.4,9z M16.4,13
H3.6C3.048,13,3,13.447,3,14c0,0.553,0.048,1,0.6,1H16.4c0.552,0,0.6-0.447,0.6-1C17,13.447,16.952,13,16.4,13z M3.6,7H16.4
C16.952,7,17,6.553,17,6c0-0.553-0.048-1-0.6-1H3.6C3.048,5,3,5.447,3,6C3,6.553,3.048,7,3.6,7z"/></svg>
</a>
<div class="title"><a href="../index.html">Blindsight</a></div>

<!--
<a href="https://www.example.com" class="logo show-for-medium">logo</a>
-->
</div>
</header>

<div class="expanded row">

<div class="medium-3 large-2 show-for-medium column">
<nav class="site-nav">
<div class="nav-home">
<a href="../index.html" >
<span class="home-icon">⌂</span>Blindsight
</a>
<div class="version-number">
0.1.35
</div>
</div>
<div class="nav-toc">
<ul>
  <li><a href="../setup/index.html" class="page">Setup</a>
  <ul>
    <li><a href="../setup/logback.html" class="page">Logback</a></li>
    <li><a href="../setup/generic.html" class="page">Generic</a></li>
  </ul></li>
  <li><a href="../usage/index.html" class="page">Usage</a>
  <ul>
    <li><a href="../usage/overview.html" class="page">Overview</a></li>
    <li><a href="../usage/resolvers.html" class="page">Logger Resolvers</a></li>
    <li><a href="../usage/slf4j.html" class="page">SLF4J API</a></li>
    <li><a href="../usage/fluent.html" class="page">Fluent API</a></li>
    <li><a href="../usage/semantic.html" class="page">Semantic API</a></li>
    <li><a href="../usage/flow.html" class="active page">Flow API</a></li>
    <li><a href="../usage/structured.html" class="page">Structured Logging</a></li>
    <li><a href="../usage/conditional.html" class="page">Conditional Logging</a></li>
    <li><a href="../usage/context.html" class="page">Contextual Logging</a></li>
    <li><a href="../usage/sourcecode.html" class="page">Source Code</a></li>
  </ul></li>
  <li><a href="../extending/index.html" class="page">Extending</a>
  <ul>
    <li><a href="../extending/overview.html" class="page">Overview</a></li>
  </ul></li>
</ul>
</div>

</nav>
</div>

<div class="small-12 medium-9 large-10 column">
<section class="site-content">

<span id="version-warning"></span>

<div class="page-header row">
<div class="medium-12 show-for-medium column">
<div class="nav-breadcrumbs">
<ul>
  <li><a href="../index.html">Blindsight</a></li>
  <li><a href="../usage/index.html">Usage</a></li>
  <li>Flow API</li>
</ul>
</div>
</div>
</div>

<div class="page-content row">
<div class="small-12 large-9 column" id="docs">
<h1><a href="#flow-api" name="flow-api" class="anchor"><span class="anchor-link"></span></a>Flow API</h1>
<p>The flow API is used when logging surrounds an execution flow. This is a good fit when you want tracing or <a href="https://martinfowler.com/articles/domain-oriented-observability.html">domain-oriented observability</a>.</p>
<p>You can access the flow logger from Blindsight using <code>logger.flow</code>:</p>
<pre class="prettyprint"><code class="language-scala">import com.tersesystems.blindsight._
import com.tersesystems.blindsight.flow._

val logger = LoggerFactory.getLogger
val flowLogger: FlowLogger = logger.flow
</code></pre>
<h2><a href="#usage" name="usage" class="anchor"><span class="anchor-link"></span></a>Usage</h2>
<p>The flow logger takes a block of execution, and returns the result transparently, according to the log level. </p>
<pre class="prettyprint"><a class="icon go-to-source" href="https://github.com/tersesystems/blindsight/tree/v0.1.35/docs/src/test/scala/example/flow/SimpleFlow.scala#L40-L42" target="_blank" title="Go to snippet source"></a><code class="language-scala">def flowMethod(arg1: Int, arg2: Int): Int = logger.flow.trace {
  arg1 + arg2
}</code></pre>
<p>The result should have a type class instance of <a href="/blindsight/api/com/tersesystems/blindsight/api/ToArguments.html" title="com.tersesystems.blindsight.api.ToArguments"><code>ToArguments</code></a>, so that it can be considered in logging. For example, if the return type is <code>Person</code>, then you must have a <code>ToArguments[Person]</code> in scope:</p>
<pre class="prettyprint"><a class="icon go-to-source" href="https://github.com/tersesystems/blindsight/tree/v0.1.35/docs/src/test/scala/example/flow/SimpleFlow.scala#L46-L57" target="_blank" title="Go to snippet source"></a><code class="language-scala">def personFlowMethod(arg1: Int, arg2: Int): Person = logger.flow.trace {
  Person(name = &quot;Will&quot;, age = arg1 + arg2)
}

case class Person(name: String, age: Int)

object Person {
  implicit val personToArguments: ToArguments[Person] = ToArguments { person =&gt;
    import com.tersesystems.blindsight.logstash.Implicits._
    Arguments(&quot;person&quot; -&gt; Map(&quot;name&quot; -&gt; person.name, &quot;age&quot; -&gt; person.age))
  }
}</code></pre>
<p>If logging is enabled, then the execution is wrapped to capture the result or execution, and then the result is returned or execution rethrown. If the logging is not enabled (whether through conditional logging, explicit filtering, or threshold), then execution of the block still proceeds but is not wrapped by a <code>Try</code> block.</p>
<h2><a href="#flow-behavior" name="flow-behavior" class="anchor"><span class="anchor-link"></span></a>Flow Behavior</h2>
<p>What happens in a flow is determined by the <a href="/blindsight/api/com/tersesystems/blindsight/flow/FlowBehavior.html" title="com.tersesystems.blindsight.flow.FlowBehavior"><code>FlowBehavior</code></a>. Implementing a flow behavior comes down to creating <a href="/blindsight/api/com/tersesystems/blindsight/api/Markers.html" title="com.tersesystems.blindsight.api.Markers"><code>Markers</code></a> and <a href="/blindsight/api/com/tersesystems/blindsight/api/Statement.html" title="com.tersesystems.blindsight.api.Statement"><code>Statement</code></a> for entry, exit, and exceptions.</p>
<p>There are two out of the box behaviors provided: <a href="/blindsight/api/com/tersesystems/blindsight/flow/SimpleFlowBehavior.html" title="com.tersesystems.blindsight.flow.SimpleFlowBehavior"><code>SimpleFlowBehavior</code></a> and <a href="/blindsight/api/com/tersesystems/blindsight/flow/XLoggerFlowBehavior.html" title="com.tersesystems.blindsight.flow.XLoggerFlowBehavior"><code>XLoggerFlowBehavior</code></a>. These are modelled after <a href="https://github.com/JohnReedLOL/pos">pos</a> and <a href="http://www.slf4j.org/extensions.html#extended_logger">XLogger</a>, respectively.</p>
<h2><a href="#integration" name="integration" class="anchor"><span class="anchor-link"></span></a>Integration</h2>
<p>Flow based logging, because it leaves the flow behavior open, is a good way to integrate with third party systems.</p>
<h3><a href="#opentracing" name="opentracing" class="anchor"><span class="anchor-link"></span></a>Opentracing</h3>
<p>While it&rsquo;s possible to set up an Opentracing <a href="/blindsight/api/com/tersesystems/blindsight/flow/FlowBehavior.html" title="com.tersesystems.blindsight.flow.FlowBehavior"><code>FlowBehavior</code></a> that creates spans directly, spans will not show up in the logs (which is confusing) and will tightly couple the Opentracing instrumentation with your logging (which may lead to bugs).</p>
<p>What you can do instead is inject your logs into an active span inside of a flow, using the <a href="https://github.com/opentracing/specification/blob/master/semantic_conventions.md#log-fields-table">standard log fields</a>:</p>
<pre class="prettyprint"><code class="language-java">ActiveSpan span = ...
span.log(ImmutableMap.of(&quot;message&quot;, message));
span.log(ImmutableMap.of(&quot;error.kind&quot;, throwable.getClass().getName()));
span.log(ImmutableMap.of(&quot;error.object&quot;, throwable));
</code></pre>
<h3><a href="#datadog" name="datadog" class="anchor"><span class="anchor-link"></span></a>Datadog</h3>
<p>You can connect your logs to Datadog traces using the <a href="https://docs.datadoghq.com/tracing/connect_logs_and_traces/java/?tab=slf4jlogback#manual-trace-id-injection">Correlation Identifier</a> using <code>dd.trace_id</code> and <code>dd.span_id</code> respectively:</p>
<pre class="prettyprint"><code class="language-scala">import datadog.trace.api.CorrelationIdentifier._

val datadogTraceId = Markers(&quot;dd.trace_id&quot; -&gt; Option(getTraceId).getOrElse(&quot;0&quot;))
val datadogSpanId = Markers(&quot;dd.span_id&quot; -&gt; Option(getSpanId).getOrElse(&quot;0&quot;))
</code></pre>
<h3><a href="#honeycomb" name="honeycomb" class="anchor"><span class="anchor-link"></span></a>Honeycomb</h3>
<p>If you integrate with <a href="https://tersesystems.github.io/terse-logback/guide/tracing/">logback-tracing</a>, then you can also log to Honeycomb using a <a href="/blindsight/api/com/tersesystems/blindsight/flow/FlowBehavior.html" title="com.tersesystems.blindsight.flow.FlowBehavior"><code>FlowBehavior</code></a>. To do this, add the following resolver:</p>
<pre><code>resolvers += Resolver.bintrayRepo(&quot;tersesystems&quot;, &quot;maven&quot;)
</code></pre>
<p>and the following dependencies:</p><dl class="dependency"><dt>sbt</dt><dd><pre class="prettyprint"><code class="language-scala">libraryDependencies += "com.tersesystems.logback" % "logback-tracing" % "latest.version"</code></pre></dd><dt>Maven</dt><dd><pre class="prettyprint"><code class="language-xml">&lt;dependency&gt;
  &lt;groupId&gt;com.tersesystems.logback&lt;/groupId&gt;
  &lt;artifactId&gt;logback-tracing&lt;/artifactId&gt;
  &lt;version&gt;latest.version&lt;/version&gt;
&lt;/dependency&gt;</code></pre></dd><dt>Gradle</dt><dd><pre class="prettyprint"><code class="language-gradle">dependencies {
  compile group: 'com.tersesystems.logback', name: 'logback-tracing', version: 'latest.version'
}</code></pre></dd></dl><dl class="dependency"><dt>sbt</dt><dd><pre class="prettyprint"><code class="language-scala">libraryDependencies += "com.tersesystems.logback" % "logback-uniqueid-appender" % "latest.version"</code></pre></dd><dt>Maven</dt><dd><pre class="prettyprint"><code class="language-xml">&lt;dependency&gt;
  &lt;groupId&gt;com.tersesystems.logback&lt;/groupId&gt;
  &lt;artifactId&gt;logback-uniqueid-appender&lt;/artifactId&gt;
  &lt;version&gt;latest.version&lt;/version&gt;
&lt;/dependency&gt;</code></pre></dd><dt>Gradle</dt><dd><pre class="prettyprint"><code class="language-gradle">dependencies {
  compile group: 'com.tersesystems.logback', name: 'logback-uniqueid-appender', version: 'latest.version'
}</code></pre></dd></dl>
<p>You can produce Honeycomb manual traces with the following:</p>
<pre class="prettyprint"><a class="icon go-to-source" href="https://github.com/tersesystems/blindsight/tree/v0.1.35/docs/src/test/scala/example/flow/HoneycombFlow.scala#L40-L140" target="_blank" title="Go to snippet source"></a><code class="language-scala">object HoneycombFlow {

  private val logger = LoggerFactory.getLogger

  private val idgen = new RandomUUIDIdGenerator
  private val builder: SpanInfo.Builder = {
    SpanInfo
      .builder()
      .setServiceName(&quot;blindsight-example&quot;)
  }

  implicit def flowMapping[B: ToArguments](
      implicit spanInfo: SpanInfo
  ): HoneycombFlowBehavior[B] = {
    new HoneycombFlowBehavior[B]
  }

  def main(args: Array[String]): Unit = {
    generateRootSpan { implicit rootSpan =&gt;
      val intResult    = flowMethod(1, 2)
      val personResult = personFlowMethod(1, 2)
    }
  }

  def flowMethod(arg1: Int, arg2: Int)(implicit spanInfo: SpanInfo): Int = {
    logger.flow.info {
      arg1 + arg2
    }
  }

  def personFlowMethod(arg1: Int, arg2: Int)(implicit spanInfo: SpanInfo): Person = {
    logger.flow.info {
      Person(name = &quot;Will&quot;, age = arg1 + arg2)
    }
  }

  private def generateRootSpan[T](block: SpanInfo =&gt; T)(implicit enclosing: Enclosing): T = {
    val rootSpan =
      builder.setRootSpan(asJavaSupplier(() =&gt; idgen.generateId()), enclosing.value).buildNow
    try {
      block(rootSpan)
    } finally {
      // The root span has to be logged _last_, after the child spans.
      logger.info(
        HoneycombFlowBehavior.markerFactory(rootSpan),
        s&quot;${enclosing.value} exit, duration ${rootSpan.duration()}&quot;
      )
    }
  }

  case class Person(name: String, age: Int)

  object Person {
    implicit val personToArguments: ToArguments[Person] = ToArguments { person =&gt;
      Arguments(&quot;person&quot; -&gt; Map(&quot;name&quot; -&gt; person.name, &quot;age&quot; -&gt; person.age))
    }
  }
}

class HoneycombFlowBehavior[B: ToArguments](implicit spanInfo: SpanInfo) extends FlowBehavior[B] {
  import HoneycombFlowBehavior.markerFactory

  // Create a thread local stack of span info.
  private val threadLocalStack: ThreadLocal[mutable.Stack[SpanInfo]] = {
    val local: ThreadLocal[mutable.Stack[SpanInfo]] = new ThreadLocal()
    local.set(mutable.Stack[SpanInfo]())
    local
  }

  override def entryStatement(source: Source): Option[Statement] = {
    // Start a child span, and push it onto the stack
    spanInfo.withChild(source.enclosing.value, asJavaFunction(pushCurrentSpan))
    None
  }

  override def throwingStatement(throwable: Throwable, source: Source): Option[(Level, Statement)] =
    Some {
      (
        Level.ERROR,
        Statement()
          .withThrowable(throwable)
          .withMarkers(Markers(markerFactory(popCurrentSpan)))
          .withMessage(s&quot;${source.enclosing.value} exception&quot;)
      )
    }

  override def exitStatement(resultValue: B, source: Source): Option[Statement] = Some {
    val span = popCurrentSpan
    Statement()
      .withMarkers(Markers(markerFactory(span)))
      .withMessage(s&quot;${source.enclosing.value} exit, duration ${span.duration()}&quot;)
      .withArguments(resultValue)
  }

  private def pushCurrentSpan(spanInfo: SpanInfo): Unit = threadLocalStack.get.push(spanInfo)
  private def popCurrentSpan: SpanInfo                  = threadLocalStack.get().pop()
}

object HoneycombFlowBehavior {
  val markerFactory = new SpanMarkerFactory
}</code></pre>
<p>See <a href="http://github.com/wsargent/play-blindsight">play-blindsight</a> for a worked example.</p>
<div class="source-github">
The source code for this page can be found <a href="https://github.com/tersesystems/blindsight/tree/v0.1.35/docs/src/main/paradox/usage/flow.md">here</a>.
</div>

<div class="nav-next">
<p><strong>Next:</strong> <a href="../usage/structured.html">Structured Logging</a></p>
</div>
</div>
<div class="large-3 show-for-large column" data-sticky-container>
<nav class="sidebar sticky" data-sticky data-anchor="docs" data-sticky-on="large">
<div class="page-nav">
<div class="nav-title">On this page:</div>
<div class="nav-toc">
<ul>
  <li><a href="../usage/flow.html#flow-api" class="header">Flow API</a>
  <ul>
    <li><a href="../usage/flow.html#usage" class="header">Usage</a></li>
    <li><a href="../usage/flow.html#flow-behavior" class="header">Flow Behavior</a></li>
    <li><a href="../usage/flow.html#integration" class="header">Integration</a></li>
  </ul></li>
</ul>
</div>
</div>
</nav>
</div>
</div>

</section>
</div>

</div>

<footer class="site-footer">

<section class="site-footer-nav">
<div class="expanded row">
<div class="small-12 large-offset-2 large-10 column">
<div class="row site-footer-content">

<div class="small-12 medium-4 large-3 text-center column">
<div class="nav-links">
<ul>
<!-- <li><a href="https://www.example.com/products/">Products</a> -->
</ul>
</div>
</div>

</div>
</div>
</div>
</section>

<section class="site-footer-base">
<div class="expanded row">
<div class="small-12 large-offset-2 large-10 column">
<div class="row site-footer-content">

<div class="small-12 text-center large-9 column">

<!--
<div class="copyright">
<span class="text">&copy; 2020</span>
<a href="https://www.example.com" class="logo">logo</a>
</div>
-->
</div>

</div>
</div>
</div>
</section>
</footer>

</div>
</div>
</div>
</body>

<script type="text/javascript" src="../lib/foundation/dist/foundation.min.js"></script>
<script type="text/javascript">jQuery(document).foundation();</script>
<script type="text/javascript" src="../js/magellan.js"></script>

<style type="text/css">@import "../lib/prettify/prettify.css";</style>
<script type="text/javascript" src="../lib/prettify/prettify.js"></script>
<script type="text/javascript" src="../lib/prettify/lang-scala.js"></script>
<script type="text/javascript">jQuery(function(){window.prettyPrint && prettyPrint()});</script>
<script type="text/javascript">jQuery(function(jq){initOldVersionWarnings(jq, '0.1.35', 'https://tersesystems.github.io/blindsight')});</script>


</html>
