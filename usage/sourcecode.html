<!DOCTYPE html>
<html class="no-js" lang="en">

<head>
<title>Source Code · Blindsight</title>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<meta name="description" content='Rich Typesafe Scala Logging API based on SLF4J'/>
<link rel="canonical" href="/blindsight/usage/sourcecode.html"/>
<link href="https://fonts.googleapis.com/css?family=Roboto:100normal,100italic,300normal,300italic,400normal,400italic,500normal,500italic,700normal,700italic,900normal,900italicc" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../lib/jquery/jquery.min.js"></script>
<script type="text/javascript" src="../js/page.js"></script>
<script type="text/javascript" src="../js/warnOldVersion.js"></script>
<script type="text/javascript" src="../js/groups.js"></script>
<script type="text/javascript" src="../js/snippets.js"></script>
<link rel="stylesheet" type="text/css" href="../lib/foundation/dist/foundation.min.css"/>
<link rel="stylesheet" type="text/css" href="../css/page.css"/>

<!--
<link rel="shortcut icon" href="../images/favicon.ico" />
-->
</head>

<body>
<div class="off-canvas-wrapper">
<div class="off-canvas-wrapper-inner" data-off-canvas-wrapper>

<div class="off-canvas position-left" id="off-canvas-menu" data-off-canvas>
<nav class="off-canvas-nav">
<div class="nav-home">
<a href="../index.html" >
<span class="home-icon">⌂</span>Blindsight
</a>
<div class="version-number">
1.5.2
</div>
</div>
<div class="nav-toc">
<ul>
  <li><a href="../setup/index.html" class="page">Setup</a></li>
  <li><a href="../usage/index.html" class="page">Usage</a>
  <ul>
    <li><a href="../usage/overview.html" class="page">Overview</a></li>
    <li><a href="../usage/resolvers.html" class="page">Logger Resolvers</a></li>
    <li><a href="../usage/dsl.html" class="page">Structured DSL</a></li>
    <li><a href="../usage/typeclasses.html" class="page">Type Classes</a></li>
    <li><a href="../usage/interpolation.html" class="page">String Interpolation</a></li>
    <li><a href="../usage/jsonld.html" class="page">JSON-LD</a></li>
    <li><a href="../usage/slf4j.html" class="page">SLF4J API</a></li>
    <li><a href="../usage/fluent.html" class="page">Fluent API</a></li>
    <li><a href="../usage/semantic.html" class="page">Semantic API</a></li>
    <li><a href="../usage/flow.html" class="page">Flow API</a></li>
    <li><a href="../usage/conditional.html" class="page">Conditional Logging</a></li>
    <li><a href="../usage/context.html" class="page">Contextual Logging</a></li>
    <li><a href="../usage/transform.html" class="page">Entry Transformation</a></li>
    <li><a href="../usage/buffer.html" class="page">Event Buffers</a></li>
    <li><a href="../usage/sourcecode.html" class="active page">Source Code</a></li>
    <li><a href="../usage/scripting.html" class="page">Scripting</a></li>
    <li><a href="../usage/inspections.html" class="page">Inspections</a></li>
  </ul></li>
  <li><a href="../extending/index.html" class="page">Extending Blindsight API</a></li>
  <li><a href="../performance/index.html" class="page">Performance</a>
  <ul>
    <li><a href="../performance/benchmarks.html" class="page">Benchmarks</a></li>
    <li><a href="../performance/memory.html" class="page">Memory Usage</a></li>
  </ul></li>
  <li><a href="../principles.html" class="page">Principles</a></li>
</ul>
</div>

</nav>
</div>

<div class="off-canvas-content" data-off-canvas-content>

<header class="site-header expanded row">
<div class="small-12 column">
<a href="#" class="off-canvas-toggle hide-for-medium" data-toggle="off-canvas-menu"><svg class="svg-icon svg-icon-menu" version="1.1" id="Menu" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" viewBox="0 0 20 20" enable-background="new 0 0 20 20" xml:space="preserve"> <path class="svg-icon-menu-path" fill="#53CDEC" d="M16.4,9H3.6C3.048,9,3,9.447,3,10c0,0.553,0.048,1,0.6,1H16.4c0.552,0,0.6-0.447,0.6-1C17,9.447,16.952,9,16.4,9z M16.4,13
H3.6C3.048,13,3,13.447,3,14c0,0.553,0.048,1,0.6,1H16.4c0.552,0,0.6-0.447,0.6-1C17,13.447,16.952,13,16.4,13z M3.6,7H16.4
C16.952,7,17,6.553,17,6c0-0.553-0.048-1-0.6-1H3.6C3.048,5,3,5.447,3,6C3,6.553,3.048,7,3.6,7z"/></svg>
</a>
<div class="title"><a href="../index.html">Blindsight</a></div>

<!--
<a href="https://www.example.com" class="logo show-for-medium">logo</a>
-->
</div>
</header>

<div class="expanded row">

<div class="medium-3 large-2 show-for-medium column">
<nav class="site-nav">
<div class="nav-home">
<a href="../index.html" >
<span class="home-icon">⌂</span>Blindsight
</a>
<div class="version-number">
1.5.2
</div>
</div>
<div class="nav-toc">
<ul>
  <li><a href="../setup/index.html" class="page">Setup</a></li>
  <li><a href="../usage/index.html" class="page">Usage</a>
  <ul>
    <li><a href="../usage/overview.html" class="page">Overview</a></li>
    <li><a href="../usage/resolvers.html" class="page">Logger Resolvers</a></li>
    <li><a href="../usage/dsl.html" class="page">Structured DSL</a></li>
    <li><a href="../usage/typeclasses.html" class="page">Type Classes</a></li>
    <li><a href="../usage/interpolation.html" class="page">String Interpolation</a></li>
    <li><a href="../usage/jsonld.html" class="page">JSON-LD</a></li>
    <li><a href="../usage/slf4j.html" class="page">SLF4J API</a></li>
    <li><a href="../usage/fluent.html" class="page">Fluent API</a></li>
    <li><a href="../usage/semantic.html" class="page">Semantic API</a></li>
    <li><a href="../usage/flow.html" class="page">Flow API</a></li>
    <li><a href="../usage/conditional.html" class="page">Conditional Logging</a></li>
    <li><a href="../usage/context.html" class="page">Contextual Logging</a></li>
    <li><a href="../usage/transform.html" class="page">Entry Transformation</a></li>
    <li><a href="../usage/buffer.html" class="page">Event Buffers</a></li>
    <li><a href="../usage/sourcecode.html" class="active page">Source Code</a></li>
    <li><a href="../usage/scripting.html" class="page">Scripting</a></li>
    <li><a href="../usage/inspections.html" class="page">Inspections</a></li>
  </ul></li>
  <li><a href="../extending/index.html" class="page">Extending Blindsight API</a></li>
  <li><a href="../performance/index.html" class="page">Performance</a>
  <ul>
    <li><a href="../performance/benchmarks.html" class="page">Benchmarks</a></li>
    <li><a href="../performance/memory.html" class="page">Memory Usage</a></li>
  </ul></li>
  <li><a href="../principles.html" class="page">Principles</a></li>
</ul>
</div>

</nav>
</div>

<div class="small-12 medium-9 large-10 column">
<section class="site-content">

<span id="version-warning"></span>

<div class="page-header row">
<div class="medium-12 show-for-medium column">
<div class="nav-breadcrumbs">
<ul>
  <li><a href="../index.html">Blindsight</a></li>
  <li><a href="../usage/index.html">Usage</a></li>
  <li>Source Code</li>
</ul>
</div>
</div>
</div>

<div class="page-content row">
<div class="small-12 large-9 column" id="docs">
<h1><a href="#source-code" name="source-code" class="anchor"><span class="anchor-link"></span></a>Source Code</h1>
<p>SLF4J can give access to the line and file of source code, but this is done at runtime and is very expensive. Blindsight provides this information for free, at compile time, through <a href="https://github.com/com-lihaoyi/sourcecode">sourcecode</a> macros. Internally, the <a href="/blindsight/api/com/tersesystems/blindsight/logstash/LogstashLoggerFactory.html" title="com.tersesystems.blindsight.logstash.LogstashLoggerFactory"><code>LogstashLoggerFactory</code></a> adds extra markers to logging statements based on the macros.</p>
<p>Note that this only provides source code info where Blindsight is used, not generally across Logback. If you want source code information out of Logback generally with the compile time overhead of caller info, check out <a href="https://tersesystems.github.io/terse-logback/guide/instrumentation/">instrumentation</a>.</p>
<h2><a href="#usage" name="usage" class="anchor"><span class="anchor-link"></span></a>Usage</h2>
<p>To enable this, use <code>blindsight-logstash</code> and add a <code>blindsight.source.enabled</code> property to the Logback context with the value of <code>true</code>:</p>
<pre class="prettyprint"><code class="language-xml">&lt;configuration&gt;
  &lt;property name=&quot;blindsight.source.enabled&quot; value=&quot;true&quot; scope=&quot;context&quot;/&gt;
 
  &lt;!-- ... --&gt;
&lt;/configuration&gt;
</code></pre>
<p>This adds <code>source.line</code>, <code>source.file</code> and <code>source.enclosing</code> to the JSON logs:</p>
<pre class="prettyprint"><code class="language-json">{
  &quot;@timestamp&quot;: &quot;2020-04-12T17:58:45.410Z&quot;,
  &quot;@version&quot;: &quot;1&quot;,
  &quot;message&quot;: &quot;this is a test&quot;,
  &quot;logger_name&quot;: &quot;example.slf4j.Slf4jMain$&quot;,
  &quot;thread_name&quot;: &quot;run-main-0&quot;,
  &quot;level&quot;: &quot;DEBUG&quot;,
  &quot;level_value&quot;: 10000,
  &quot;source.line&quot;: 39,
  &quot;source.file&quot;: &quot;/home/wsargent/work/blindsight/example/src/main/scala/example/slf4j/Slf4jMain.scala&quot;,
  &quot;source.enclosing&quot;: &quot;example.slf4j.Slf4jMain.main&quot;
}
</code></pre>
<h2><a href="#changing-property-names" name="changing-property-names" class="anchor"><span class="anchor-link"></span></a>Changing Property Names</h2>
<p>This is the default behavior. You can change the name of the labels used in the event that you have a conflict.</p>
<blockquote>
  <p>For example, <a href="https://www.elastic.co/guide/en/beats/filebeat/6.8/index.html">Filebeat 6.8 and later</a> uses <a href="https://www.elastic.co/guide/en/beats/filebeat/6.8/migration-changed-fields.html#_the_file_field_was_renamed_to_source">source.*</a> internally and will not collect logs if a field with that prefix already exists.</p>
</blockquote>
<p>To change the source labels to fit <a href="https://www.elastic.co/guide/en/ecs/1.7/ecs-log.html#field-log-origin-file-line">Elastic Common Schema</a>, you can set the properties in <code>logback.xml</code>:</p>
<pre class="prettyprint"><code class="language-xml">&lt;configuration&gt;
  &lt;property name=&quot;blindsight.source.file&quot; value=&quot;log.origin.file.name&quot; scope=&quot;context&quot;/&gt;
  &lt;property name=&quot;blindsight.source.line&quot; value=&quot;log.origin.file.line&quot; scope=&quot;context&quot;/&gt;
  &lt;property name=&quot;blindsight.source.enclosing&quot; value=&quot;log.origin.function&quot; scope=&quot;context&quot;/&gt;

&lt;!-- ... --&gt;
&lt;/configuration&gt;
</code></pre>
<h2><a href="#customizing-loggerfactory" name="customizing-loggerfactory" class="anchor"><span class="anchor-link"></span></a>Customizing LoggerFactory</h2>
<p>If you want to customize the source code behavior, you can provide your own <code>LoggerFactory</code> implementation. The <code>LoggerFactory</code> is provided from a service loader implementation, so the easiest thing to do is install the <a href="../setup/index.html">generic</a> logger and implement <code>META-INF/services/com.tersesystems.blindsight.LoggerFactory</code> with your own <code>LoggerFactory</code>.</p>
<p>Writing your own logger factory is not too hard &ndash; here&rsquo;s the <code>LogstashLoggerFactory</code> for reference.</p>
<pre class="prettyprint"><code class="language-scala">class LogstashLoggerFactory extends LoggerFactory {
  override def getLogger[T: LoggerResolver](instance: T): Logger = {
    val underlying = implicitly[LoggerResolver[T]].resolveLogger(instance)
    new Logger.Impl(CoreLogger(underlying, sourceInfoBehavior(underlying)))
  }

  protected def sourceInfoBehavior(underlying: org.slf4j.Logger): Option[SourceInfoBehavior] = {
    if (sourceInfoEnabled(underlying)) {
      Some(sourceInfoAsMarker(underlying))
    } else {
      None
    }
  }

  protected def sourceInfoEnabled(underlying: org.slf4j.Logger): Boolean = {
    val enabled = property(underlying, LogstashLoggerFactory.SourceEnabledProperty)
    java.lang.Boolean.parseBoolean(enabled.getOrElse(java.lang.Boolean.FALSE.toString))
  }

  protected def property(underlying: org.slf4j.Logger, propertyName: String): Option[String] = {
    val logbackLogger = underlying.asInstanceOf[ch.qos.logback.classic.Logger]
    Option(logbackLogger.getLoggerContext.getProperty(propertyName))
  }

  protected def sourceInfoAsMarker(underlying: org.slf4j.Logger): SourceInfoBehavior = {
    import LogstashLoggerFactory._
    val fileLabel      = property(underlying, SourceFileProperty).getOrElse(&quot;source.file&quot;)
    val lineLabel      = property(underlying, SourceLineProperty).getOrElse(&quot;source.line&quot;)
    val enclosingLabel = property(underlying, SourceEnclosingProperty).getOrElse(&quot;source.enclosing&quot;)
    new SourceInfoBehavior.Impl(fileLabel, lineLabel, enclosingLabel)
  }

}

object LogstashLoggerFactory {
  val SourceEnabledProperty   = &quot;blindsight.source.enabled&quot;
  val SourceFileProperty      = &quot;blindsight.source.file&quot;
  val SourceLineProperty      = &quot;blindsight.source.line&quot;
  val SourceEnclosingProperty = &quot;blindsight.source.enclosing&quot;
}
</code></pre>
<div class="source-github">
The source code for this page can be found <a href="https://github.com/tersesystems/blindsight/tree/v1.5.2/docs/src/main/paradox/usage/sourcecode.md">here</a>.
</div>

<div class="nav-next">
<p><strong>Next:</strong> <a href="../usage/scripting.html">Scripting</a></p>
</div>
</div>
<div class="large-3 show-for-large column" data-sticky-container>
<nav class="sidebar sticky" data-sticky data-anchor="docs" data-sticky-on="large">
<div class="page-nav">
<div class="nav-title">On this page:</div>
<div class="nav-toc">
<ul>
  <li><a href="../usage/sourcecode.html#source-code" class="header">Source Code</a>
  <ul>
    <li><a href="../usage/sourcecode.html#usage" class="header">Usage</a></li>
    <li><a href="../usage/sourcecode.html#changing-property-names" class="header">Changing Property Names</a></li>
    <li><a href="../usage/sourcecode.html#customizing-loggerfactory" class="header">Customizing LoggerFactory</a></li>
  </ul></li>
</ul>
</div>
</div>
</nav>
</div>
</div>

</section>
</div>

</div>

<footer class="site-footer">

<section class="site-footer-nav">
<div class="expanded row">
<div class="small-12 large-offset-2 large-10 column">
<div class="row site-footer-content">

<div class="small-12 medium-4 large-3 text-center column">
<div class="nav-links">
<ul>
<!-- <li><a href="https://www.example.com/products/">Products</a> -->
</ul>
</div>
</div>

</div>
</div>
</div>
</section>

<section class="site-footer-base">
<div class="expanded row">
<div class="small-12 large-offset-2 large-10 column">
<div class="row site-footer-content">

<div class="small-12 text-center large-9 column">

<!--
<div class="copyright">
<span class="text">&copy; 2021</span>
<a href="https://www.example.com" class="logo">logo</a>
</div>
-->
</div>

</div>
</div>
</div>
</section>
</footer>

</div>
</div>
</div>
</body>

<script type="text/javascript" src="../lib/foundation/dist/foundation.min.js"></script>
<script type="text/javascript">jQuery(document).foundation();</script>
<script type="text/javascript" src="../js/magellan.js"></script>

<style type="text/css">@import "../lib/prettify/prettify.css";</style>
<script type="text/javascript" src="../lib/prettify/prettify.js"></script>
<script type="text/javascript" src="../lib/prettify/lang-scala.js"></script>
<script type="text/javascript">jQuery(function(){window.prettyPrint && prettyPrint()});</script>
<script type="text/javascript">jQuery(function(jq){initOldVersionWarnings(jq, '1.5.2', 'https://tersesystems.github.io/blindsight')});</script>


</html>
