<!DOCTYPE html>
<html class="no-js" lang="en">

<head>
<title>Event Buffers · Blindsight</title>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<meta name="description" content='Rich Typesafe Scala Logging API based on SLF4J'/>
<link rel="canonical" href="/blindsight/usage/buffer.html"/>
<link href="https://fonts.googleapis.com/css?family=Roboto:100normal,100italic,300normal,300italic,400normal,400italic,500normal,500italic,700normal,700italic,900normal,900italicc" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../lib/jquery/jquery.min.js"></script>
<script type="text/javascript" src="../js/page.js"></script>
<script type="text/javascript" src="../js/warnOldVersion.js"></script>
<script type="text/javascript" src="../js/groups.js"></script>
<script type="text/javascript" src="../js/snippets.js"></script>
<link rel="stylesheet" type="text/css" href="../lib/foundation/dist/foundation.min.css"/>
<link rel="stylesheet" type="text/css" href="../css/page.css"/>

<!--
<link rel="shortcut icon" href="../images/favicon.ico" />
-->
</head>

<body>
<div class="off-canvas-wrapper">
<div class="off-canvas-wrapper-inner" data-off-canvas-wrapper>

<div class="off-canvas position-left" id="off-canvas-menu" data-off-canvas>
<nav class="off-canvas-nav">
<div class="nav-home">
<a href="../index.html" >
<span class="home-icon">⌂</span>Blindsight
</a>
<div class="version-number">
1.5.2
</div>
</div>
<div class="nav-toc">
<ul>
  <li><a href="../setup/index.html" class="page">Setup</a></li>
  <li><a href="../usage/index.html" class="page">Usage</a>
  <ul>
    <li><a href="../usage/overview.html" class="page">Overview</a></li>
    <li><a href="../usage/resolvers.html" class="page">Logger Resolvers</a></li>
    <li><a href="../usage/dsl.html" class="page">Structured DSL</a></li>
    <li><a href="../usage/typeclasses.html" class="page">Type Classes</a></li>
    <li><a href="../usage/interpolation.html" class="page">String Interpolation</a></li>
    <li><a href="../usage/jsonld.html" class="page">JSON-LD</a></li>
    <li><a href="../usage/slf4j.html" class="page">SLF4J API</a></li>
    <li><a href="../usage/fluent.html" class="page">Fluent API</a></li>
    <li><a href="../usage/semantic.html" class="page">Semantic API</a></li>
    <li><a href="../usage/flow.html" class="page">Flow API</a></li>
    <li><a href="../usage/conditional.html" class="page">Conditional Logging</a></li>
    <li><a href="../usage/context.html" class="page">Contextual Logging</a></li>
    <li><a href="../usage/transform.html" class="page">Entry Transformation</a></li>
    <li><a href="../usage/buffer.html" class="active page">Event Buffers</a></li>
    <li><a href="../usage/sourcecode.html" class="page">Source Code</a></li>
    <li><a href="../usage/scripting.html" class="page">Scripting</a></li>
    <li><a href="../usage/inspections.html" class="page">Inspections</a></li>
  </ul></li>
  <li><a href="../extending/index.html" class="page">Extending Blindsight API</a></li>
  <li><a href="../performance/index.html" class="page">Performance</a>
  <ul>
    <li><a href="../performance/benchmarks.html" class="page">Benchmarks</a></li>
    <li><a href="../performance/memory.html" class="page">Memory Usage</a></li>
  </ul></li>
  <li><a href="../principles.html" class="page">Principles</a></li>
</ul>
</div>

</nav>
</div>

<div class="off-canvas-content" data-off-canvas-content>

<header class="site-header expanded row">
<div class="small-12 column">
<a href="#" class="off-canvas-toggle hide-for-medium" data-toggle="off-canvas-menu"><svg class="svg-icon svg-icon-menu" version="1.1" id="Menu" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" viewBox="0 0 20 20" enable-background="new 0 0 20 20" xml:space="preserve"> <path class="svg-icon-menu-path" fill="#53CDEC" d="M16.4,9H3.6C3.048,9,3,9.447,3,10c0,0.553,0.048,1,0.6,1H16.4c0.552,0,0.6-0.447,0.6-1C17,9.447,16.952,9,16.4,9z M16.4,13
H3.6C3.048,13,3,13.447,3,14c0,0.553,0.048,1,0.6,1H16.4c0.552,0,0.6-0.447,0.6-1C17,13.447,16.952,13,16.4,13z M3.6,7H16.4
C16.952,7,17,6.553,17,6c0-0.553-0.048-1-0.6-1H3.6C3.048,5,3,5.447,3,6C3,6.553,3.048,7,3.6,7z"/></svg>
</a>
<div class="title"><a href="../index.html">Blindsight</a></div>

<!--
<a href="https://www.example.com" class="logo show-for-medium">logo</a>
-->
</div>
</header>

<div class="expanded row">

<div class="medium-3 large-2 show-for-medium column">
<nav class="site-nav">
<div class="nav-home">
<a href="../index.html" >
<span class="home-icon">⌂</span>Blindsight
</a>
<div class="version-number">
1.5.2
</div>
</div>
<div class="nav-toc">
<ul>
  <li><a href="../setup/index.html" class="page">Setup</a></li>
  <li><a href="../usage/index.html" class="page">Usage</a>
  <ul>
    <li><a href="../usage/overview.html" class="page">Overview</a></li>
    <li><a href="../usage/resolvers.html" class="page">Logger Resolvers</a></li>
    <li><a href="../usage/dsl.html" class="page">Structured DSL</a></li>
    <li><a href="../usage/typeclasses.html" class="page">Type Classes</a></li>
    <li><a href="../usage/interpolation.html" class="page">String Interpolation</a></li>
    <li><a href="../usage/jsonld.html" class="page">JSON-LD</a></li>
    <li><a href="../usage/slf4j.html" class="page">SLF4J API</a></li>
    <li><a href="../usage/fluent.html" class="page">Fluent API</a></li>
    <li><a href="../usage/semantic.html" class="page">Semantic API</a></li>
    <li><a href="../usage/flow.html" class="page">Flow API</a></li>
    <li><a href="../usage/conditional.html" class="page">Conditional Logging</a></li>
    <li><a href="../usage/context.html" class="page">Contextual Logging</a></li>
    <li><a href="../usage/transform.html" class="page">Entry Transformation</a></li>
    <li><a href="../usage/buffer.html" class="active page">Event Buffers</a></li>
    <li><a href="../usage/sourcecode.html" class="page">Source Code</a></li>
    <li><a href="../usage/scripting.html" class="page">Scripting</a></li>
    <li><a href="../usage/inspections.html" class="page">Inspections</a></li>
  </ul></li>
  <li><a href="../extending/index.html" class="page">Extending Blindsight API</a></li>
  <li><a href="../performance/index.html" class="page">Performance</a>
  <ul>
    <li><a href="../performance/benchmarks.html" class="page">Benchmarks</a></li>
    <li><a href="../performance/memory.html" class="page">Memory Usage</a></li>
  </ul></li>
  <li><a href="../principles.html" class="page">Principles</a></li>
</ul>
</div>

</nav>
</div>

<div class="small-12 medium-9 large-10 column">
<section class="site-content">

<span id="version-warning"></span>

<div class="page-header row">
<div class="medium-12 show-for-medium column">
<div class="nav-breadcrumbs">
<ul>
  <li><a href="../index.html">Blindsight</a></li>
  <li><a href="../usage/index.html">Usage</a></li>
  <li>Event Buffers</li>
</ul>
</div>
</div>
</div>

<div class="page-content row">
<div class="small-12 large-9 column" id="docs">
<h1><a href="#event-buffers" name="event-buffers" class="anchor"><span class="anchor-link"></span></a>Event Buffers</h1>
<p>Blindsight can buffer logged events before they are sent to SLF4J. An <a href="/blindsight/api/com/tersesystems/blindsight/EventBuffer$$Event.html" title="com.tersesystems.blindsight.EventBuffer.Event"><code>Event</code></a> contain a timestamp, the logging level, the logger name, and the <a href="/blindsight/api/com/tersesystems/blindsight/Entry.html" title="com.tersesystems.blindsight.Entry"><code>Entry</code></a> that is about to be logged. Internally, event buffers are implemented as a special case of <a href="transform.html">entry transformation</a>.</p><div class="callout note "><div class="callout-title">Note</div>
<p>Because the event is generated just before being sent to SLF4J, the timestamp of the event and the logging timestamp may differ, typically by milliseconds.</p></div>
<h2><a href="#usage" name="usage" class="anchor"><span class="anchor-link"></span></a>Usage</h2>
<p>Blindsight does not mandate the use of an event buffer, and so you must provide an implementation to your application. The easiest way to do this is to add the <a href="../setup/index.html">ringbuffer implementation</a> as a library dependency, and then use the factory constructor which will call the implementation through a service loader pattern:</p>
<pre class="prettyprint"><code class="language-scala">import com.tersesystems.blindsight._

val eventBuffer = EventBuffer(50) // buffers 50 elements
</code></pre>
<p>You can then add the buffer to the logger with <code>withEventBuffer</code>:</p>
<pre class="prettyprint"><code class="nocode">val logger = LoggerFactory.getLogger.withEventBuffer(eventBuffer)
</code></pre>
<p>Or you can target an individual level for buffering:</p>
<pre class="prettyprint"><code class="nocode">import org.slf4j.event.Level
val logger = LoggerFactory.getLogger.withEventBuffer(Level.WARN, eventBuffer)
</code></pre>
<p>The logger will append events to the buffer when they pass the criteria for logging:</p>
<pre class="prettyprint"><code class="language-scala">logger.warn(&quot;I am a warning message&quot;)
val e = eventBuffer.take(1)
println(s&quot;${e.timestamp}: ${e.level} - ${e.entry.message}&quot;)
</code></pre>
<p>Adding events to the ring buffer will mean that entries will live longer than usual (adding memory allocations and CPU), and will be accessible inside the application, which may have security implications. </p>
<p>You can clear the buffer at any time by calling <code>clear</code>:</p>
<pre class="prettyprint"><code class="language-scala">eventBuffer.clear()
</code></pre>
<h2><a href="#patterns" name="patterns" class="anchor"><span class="anchor-link"></span></a>Patterns</h2>
<p>Because event buffers are a new feature, the question of how to use buffers effectively is still open. Some examples of buffer patterns are provided below. </p>
<p>Brian Marick&rsquo;s <a href="http://www.exampler.com/writing/ring-buffer.pdf">Using Ring Buffer Logging to Help Find Bugs</a> is also gem of good practices, and worth reading.</p>
<h3><a href="#buffers-in-testing" name="buffers-in-testing" class="anchor"><span class="anchor-link"></span></a>Buffers in Testing</h3>
<p>Using buffers for testing is relatively straightforward. You can add an event buffer, and verify that the markers, messages, and arguments translate appropriately to SLF4J.</p>
<pre class="prettyprint"><code class="language-scala">&quot;log something and see it in buffer&quot; in {
  val queueBuffer = EventBuffer(1)
  val logger      = createLogger.withEventBuffer(queueBuffer)

  logger.info(&quot;Hello world&quot;)

  val el = queueBuffer.head
  el.entry.marker must be(None)
  el.entry.message must be(&quot;Hello world&quot;)
  el.entry.args must be(empty)
}
</code></pre>
<h3><a href="#buffers-in-debugging" name="buffers-in-debugging" class="anchor"><span class="anchor-link"></span></a>Buffers in Debugging</h3>
<p>Using buffers in debugging can be useful to provide more context in a running program, to provide detailed history on demand and show a record. It can be particularly helpful in the context of a debugger, because you can see the history of the events in the array &ndash; essentially using the buffers as logs, but without having to context switch.</p>
<p>One problem in debugging is that there can be an overwhelming amount of information, and hunting down exactly when and where something went wrong can be an issue. One way to handle this to create several buffers so you can filter out fine details.</p>
<pre class="prettyprint"><code class="language-scala">val logger = LoggerFactory.getLogger
    .withEventBuffer(Level.DEBUG, debugBuffer)
    .withEventBuffer(Level.TRACE, traceBuffer)

logger.debug { log =&gt;
  log(&quot;general info&quot;)
}

logger.trace { log =&gt; 
  log(&quot;verbose info&quot;)
}
</code></pre>
<p>You can also dump and search through buffers while debugging for a richer development experience:</p>
<pre class="prettyprint"><code class="language-scala">val bufferList = buffer.take(buffer.size)
bufferList.find(_.entry.message.startsWith(&quot;IMPORTANT&quot;)).foreach { e =&gt;
  println(s&quot;Found important event $e&quot;)
}
</code></pre>
<h3><a href="#buffers-in-production" name="buffers-in-production" class="anchor"><span class="anchor-link"></span></a>Buffers in Production</h3>
<p>Buffers can be enabled in production, but be specifically <a href="https://tersesystems.com/blog/2019/07/22/targeted-diagnostic-logging-in-production/">targeted</a> using <a href="conditional.html">conditional logging</a> so that debugging and tracing information is only buffered by request. </p><div class="callout note "><div class="callout-title">Note</div>
<p>You may also need to enable the logger level as <code>TRACE</code> to ensure that logging passes the built-in predicates. If you want <code>DEBUG</code> and <code>TRACE</code> statements to be logged <strong>only</strong> to the buffer, you should use <a href="http://logback.qos.ch/manual/filters.html#thresholdFilter">threshold filters</a> on the appenders to suppress any output.</p></div>
<pre class="prettyprint"><code class="language-scala">// enable buffer logging based off feature flags...
private def bufferEnabled(markers: Markers) = ...

val logCondition = Condition { (level: Level, markers: Markers) =&gt;
  level.toInt.compareTo(Level.DEBUG.toInt) &gt; 0 || bufferEnabled(markers)
}

val logger = baseLogger
    .withMarkers(operationMarkers)
    .withCondition(logCondition)
    .withEventBuffer(Level.DEBUG, buffer)
    .withEventBuffer(Level.TRACE, buffer)

logger.debug { log =&gt;
  log(&quot;logging debug information that will go to buffer&quot;)
}
</code></pre>
<p>You can then set up the events as <a href="https://github.com/tersesystems/terse-logback-showcase/blob/master/app/handlers/SentryHandler.java">breadcrumbs</a> to your error handling system:</p>
<pre class="prettyprint"><code class="language-scala">try {
  // throw exception
} catch {
  case e: Exception =&gt;
    val bufferList = buffer.take(buffer.size)
    val breadcrumbs = buildBreadcrumbs(bufferList)
    val errorEvent = buildEvent(usefulException, breadcrumbs);
    sentryClient.sendEvent(errorEvent);
}
</code></pre>
<div class="source-github">
The source code for this page can be found <a href="https://github.com/tersesystems/blindsight/tree/v1.5.2/docs/src/main/paradox/usage/buffer.md">here</a>.
</div>

<div class="nav-next">
<p><strong>Next:</strong> <a href="../usage/sourcecode.html">Source Code</a></p>
</div>
</div>
<div class="large-3 show-for-large column" data-sticky-container>
<nav class="sidebar sticky" data-sticky data-anchor="docs" data-sticky-on="large">
<div class="page-nav">
<div class="nav-title">On this page:</div>
<div class="nav-toc">
<ul>
  <li><a href="../usage/buffer.html#event-buffers" class="header">Event Buffers</a>
  <ul>
    <li><a href="../usage/buffer.html#usage" class="header">Usage</a></li>
    <li><a href="../usage/buffer.html#patterns" class="header">Patterns</a></li>
  </ul></li>
</ul>
</div>
</div>
</nav>
</div>
</div>

</section>
</div>

</div>

<footer class="site-footer">

<section class="site-footer-nav">
<div class="expanded row">
<div class="small-12 large-offset-2 large-10 column">
<div class="row site-footer-content">

<div class="small-12 medium-4 large-3 text-center column">
<div class="nav-links">
<ul>
<!-- <li><a href="https://www.example.com/products/">Products</a> -->
</ul>
</div>
</div>

</div>
</div>
</div>
</section>

<section class="site-footer-base">
<div class="expanded row">
<div class="small-12 large-offset-2 large-10 column">
<div class="row site-footer-content">

<div class="small-12 text-center large-9 column">

<!--
<div class="copyright">
<span class="text">&copy; 2021</span>
<a href="https://www.example.com" class="logo">logo</a>
</div>
-->
</div>

</div>
</div>
</div>
</section>
</footer>

</div>
</div>
</div>
</body>

<script type="text/javascript" src="../lib/foundation/dist/foundation.min.js"></script>
<script type="text/javascript">jQuery(document).foundation();</script>
<script type="text/javascript" src="../js/magellan.js"></script>

<style type="text/css">@import "../lib/prettify/prettify.css";</style>
<script type="text/javascript" src="../lib/prettify/prettify.js"></script>
<script type="text/javascript" src="../lib/prettify/lang-scala.js"></script>
<script type="text/javascript">jQuery(function(){window.prettyPrint && prettyPrint()});</script>
<script type="text/javascript">jQuery(function(jq){initOldVersionWarnings(jq, '1.5.2', 'https://tersesystems.github.io/blindsight')});</script>


</html>
