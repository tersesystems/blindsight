<!DOCTYPE html>
<html class="no-js" lang="en">

<head>
<title>Contextual Logging · Blindsight</title>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<meta name="description" content='Rich Typesafe Scala Logging API based on SLF4J'/>
<link rel="canonical" href="/blindsight/usage/context.html"/>
<link href="https://fonts.googleapis.com/css?family=Roboto:100normal,100italic,300normal,300italic,400normal,400italic,500normal,500italic,700normal,700italic,900normal,900italicc" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../lib/jquery/jquery.min.js"></script>
<script type="text/javascript" src="../js/page.js"></script>
<script type="text/javascript" src="../js/warnOldVersion.js"></script>
<script type="text/javascript" src="../js/groups.js"></script>
<script type="text/javascript" src="../js/snippets.js"></script>
<link rel="stylesheet" type="text/css" href="../lib/foundation/dist/foundation.min.css"/>
<link rel="stylesheet" type="text/css" href="../css/page.css"/>

<!--
<link rel="shortcut icon" href="../images/favicon.ico" />
-->
</head>

<body>
<div class="off-canvas-wrapper">
<div class="off-canvas-wrapper-inner" data-off-canvas-wrapper>

<div class="off-canvas position-left" id="off-canvas-menu" data-off-canvas>
<nav class="off-canvas-nav">
<div class="nav-home">
<a href="../index.html" >
<span class="home-icon">⌂</span>Blindsight
</a>
<div class="version-number">
1.5.2
</div>
</div>
<div class="nav-toc">
<ul>
  <li><a href="../setup/index.html" class="page">Setup</a></li>
  <li><a href="../usage/index.html" class="page">Usage</a>
  <ul>
    <li><a href="../usage/overview.html" class="page">Overview</a></li>
    <li><a href="../usage/resolvers.html" class="page">Logger Resolvers</a></li>
    <li><a href="../usage/dsl.html" class="page">Structured DSL</a></li>
    <li><a href="../usage/typeclasses.html" class="page">Type Classes</a></li>
    <li><a href="../usage/interpolation.html" class="page">String Interpolation</a></li>
    <li><a href="../usage/jsonld.html" class="page">JSON-LD</a></li>
    <li><a href="../usage/slf4j.html" class="page">SLF4J API</a></li>
    <li><a href="../usage/fluent.html" class="page">Fluent API</a></li>
    <li><a href="../usage/semantic.html" class="page">Semantic API</a></li>
    <li><a href="../usage/flow.html" class="page">Flow API</a></li>
    <li><a href="../usage/conditional.html" class="page">Conditional Logging</a></li>
    <li><a href="../usage/context.html" class="active page">Contextual Logging</a></li>
    <li><a href="../usage/transform.html" class="page">Entry Transformation</a></li>
    <li><a href="../usage/buffer.html" class="page">Event Buffers</a></li>
    <li><a href="../usage/sourcecode.html" class="page">Source Code</a></li>
    <li><a href="../usage/scripting.html" class="page">Scripting</a></li>
    <li><a href="../usage/inspections.html" class="page">Inspections</a></li>
  </ul></li>
  <li><a href="../extending/index.html" class="page">Extending Blindsight API</a></li>
  <li><a href="../performance/index.html" class="page">Performance</a>
  <ul>
    <li><a href="../performance/benchmarks.html" class="page">Benchmarks</a></li>
    <li><a href="../performance/memory.html" class="page">Memory Usage</a></li>
  </ul></li>
  <li><a href="../principles.html" class="page">Principles</a></li>
</ul>
</div>

</nav>
</div>

<div class="off-canvas-content" data-off-canvas-content>

<header class="site-header expanded row">
<div class="small-12 column">
<a href="#" class="off-canvas-toggle hide-for-medium" data-toggle="off-canvas-menu"><svg class="svg-icon svg-icon-menu" version="1.1" id="Menu" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" viewBox="0 0 20 20" enable-background="new 0 0 20 20" xml:space="preserve"> <path class="svg-icon-menu-path" fill="#53CDEC" d="M16.4,9H3.6C3.048,9,3,9.447,3,10c0,0.553,0.048,1,0.6,1H16.4c0.552,0,0.6-0.447,0.6-1C17,9.447,16.952,9,16.4,9z M16.4,13
H3.6C3.048,13,3,13.447,3,14c0,0.553,0.048,1,0.6,1H16.4c0.552,0,0.6-0.447,0.6-1C17,13.447,16.952,13,16.4,13z M3.6,7H16.4
C16.952,7,17,6.553,17,6c0-0.553-0.048-1-0.6-1H3.6C3.048,5,3,5.447,3,6C3,6.553,3.048,7,3.6,7z"/></svg>
</a>
<div class="title"><a href="../index.html">Blindsight</a></div>

<!--
<a href="https://www.example.com" class="logo show-for-medium">logo</a>
-->
</div>
</header>

<div class="expanded row">

<div class="medium-3 large-2 show-for-medium column">
<nav class="site-nav">
<div class="nav-home">
<a href="../index.html" >
<span class="home-icon">⌂</span>Blindsight
</a>
<div class="version-number">
1.5.2
</div>
</div>
<div class="nav-toc">
<ul>
  <li><a href="../setup/index.html" class="page">Setup</a></li>
  <li><a href="../usage/index.html" class="page">Usage</a>
  <ul>
    <li><a href="../usage/overview.html" class="page">Overview</a></li>
    <li><a href="../usage/resolvers.html" class="page">Logger Resolvers</a></li>
    <li><a href="../usage/dsl.html" class="page">Structured DSL</a></li>
    <li><a href="../usage/typeclasses.html" class="page">Type Classes</a></li>
    <li><a href="../usage/interpolation.html" class="page">String Interpolation</a></li>
    <li><a href="../usage/jsonld.html" class="page">JSON-LD</a></li>
    <li><a href="../usage/slf4j.html" class="page">SLF4J API</a></li>
    <li><a href="../usage/fluent.html" class="page">Fluent API</a></li>
    <li><a href="../usage/semantic.html" class="page">Semantic API</a></li>
    <li><a href="../usage/flow.html" class="page">Flow API</a></li>
    <li><a href="../usage/conditional.html" class="page">Conditional Logging</a></li>
    <li><a href="../usage/context.html" class="active page">Contextual Logging</a></li>
    <li><a href="../usage/transform.html" class="page">Entry Transformation</a></li>
    <li><a href="../usage/buffer.html" class="page">Event Buffers</a></li>
    <li><a href="../usage/sourcecode.html" class="page">Source Code</a></li>
    <li><a href="../usage/scripting.html" class="page">Scripting</a></li>
    <li><a href="../usage/inspections.html" class="page">Inspections</a></li>
  </ul></li>
  <li><a href="../extending/index.html" class="page">Extending Blindsight API</a></li>
  <li><a href="../performance/index.html" class="page">Performance</a>
  <ul>
    <li><a href="../performance/benchmarks.html" class="page">Benchmarks</a></li>
    <li><a href="../performance/memory.html" class="page">Memory Usage</a></li>
  </ul></li>
  <li><a href="../principles.html" class="page">Principles</a></li>
</ul>
</div>

</nav>
</div>

<div class="small-12 medium-9 large-10 column">
<section class="site-content">

<span id="version-warning"></span>

<div class="page-header row">
<div class="medium-12 show-for-medium column">
<div class="nav-breadcrumbs">
<ul>
  <li><a href="../index.html">Blindsight</a></li>
  <li><a href="../usage/index.html">Usage</a></li>
  <li>Contextual Logging</li>
</ul>
</div>
</div>
</div>

<div class="page-content row">
<div class="small-12 large-9 column" id="docs">
<h1><a href="#contextual-logging" name="contextual-logging" class="anchor"><span class="anchor-link"></span></a>Contextual Logging</h1>
<p>Blindsight can handle context cleanly over multiple threads. Context is handled through an immutable API that returns new instances on modification.</p>
<p>This is very useful when you are logging complex operations because a complete picture is often not available at the beginning of the unit of work. The more context you have in your logs, the better.</p>
<p>Blindsight does not use MDC for managing context, and does not touch thread local storage. Instead, it uses markers and builds up those markers for use in structured logging, returning a logger that will automatically apply those markers as context.</p>
<p>The assumption is that you will be using <a href="https://tersesystems.github.io/terse-logback/">Terse Logback</a>. You should also read through how to create your own <a href="https://tersesystems.com/blog/2019/05/18/application-logging-in-java-part-4/">markers</a> for use in logging. </p>
<p>Mark McBride has a blog post on <a href="https://www.honeycomb.io/blog/event-foo-moar-context-better-events/">adding context to events using the Five Ws</a> that talks about what context is appropriate to add.</p>
<h2><a href="#the-easy-way" name="the-easy-way" class="anchor"><span class="anchor-link"></span></a>The Easy Way</h2>
<p>The easy way to use contextual logging is to use the <a href="dsl.html">DSL</a> with <code>blindsight-logstash</code>:</p>
<pre class="prettyprint"><code class="language-scala">import com.tersesystems.blindsight._
import DSL._

val correlationId: String = &quot;123&quot;
val clogger = logger.withMarker(bobj(&quot;correlationId&quot; -&gt; correlationId))
clogger.info(&quot;This will log to JSON with a correlationId field&quot;)
</code></pre>
<p>This will do everything right behind the scenes, by building up context on the logger.</p>
<h2><a href="#general-principles" name="general-principles" class="anchor"><span class="anchor-link"></span></a>General Principles</h2>
<p>There may be times when you want to work with <code>org.slf4j.Marker</code> or <a href="/blindsight/api/com/tersesystems/blindsight/api/Markers.html" title="com.tersesystems.blindsight.api.Markers"><code>Markers</code></a> in more detail.</p>
<p>Blindsight allows state to be built up <a href="/blindsight/api/com/tersesystems/blindsight/api/Markers.html" title="com.tersesystems.blindsight.api.Markers"><code>Markers</code></a> wrapping a set of SLF4J marker objects.</p>
<p>There is an implicit that converts an <code>org.slf4j.Marker</code> into a <code>Markers</code> instance:</p>
<pre class="prettyprint"><code class="language-scala">val entryLogger = logger.withMarker(MarkerFactory.getMarker(&quot;ENTRY&quot;))
entryLogger.trace(&quot;entry: entering method&quot;)
</code></pre>
<p>Or you can use the <a href="/blindsight/api/com/tersesystems/blindsight/MarkersEnrichment.html" title="com.tersesystems.blindsight.MarkersEnrichment"><code>MarkersEnrichment</code></a> that adds an <code>asMarkers</code> method to <code>org.slf4j.Marker</code> through type enrichment:</p>
<pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/tersesystems/blindsight/tree/v1.5.2/docs/src/test/scala/example/typeclasses/TypeClassExample.scala#L18-L19" target="_blank" title="Go to snippet source">source</a><code class="language-scala">import MarkersEnrichment._ // adds &quot;asMarkers&quot; to org.slf4j.Marker
val markers: Markers = marker.asMarkers</code></pre>
<p>You can accumulate several markers on the logger:</p>
<pre class="prettyprint"><code class="language-scala">import net.logstash.logback.marker.{Markers =&gt; LogstashMarkers}
val loggerWithTwoMarkers = entryLogger.withMarker(LogstashMarkers.append(&quot;user&quot;, &quot;will&quot;))
</code></pre>
<p>The markers are not added to each other &ndash; in fact, there is no absolutely use of SLF4J marker parent/child relationships or SLF4J iterators in the code. Instead, they&rsquo;re handled by a Scala immutable set, and a custom parent marker is created lazily when you call <code>markers.marker</code>.</p><div class="callout note "><div class="callout-title">Note</div>
<p>You should not call <code>marker.add(childMarker)</code> or otherwise use the SLF4J Marker API, as it directly mutates marker internal state.</p></div>
<p>The markers are available from the logger using <code>logger.markers</code>, which can be useful if you need to extract a correlation id for use in tracing:</p>
<pre class="prettyprint"><code class="language-scala">val markers: Markers = entryLogger.markers
val parentMarker: Marker = markers.marker
</code></pre>
<p>You can log with markers as usual, and they will be added on top of the logger&rsquo;s markers:</p>
<pre class="prettyprint"><code class="language-scala">val anotherMarker = ... 
entryLogger.info(anotherMarker, &quot;a message&quot;)
</code></pre>
<p>Managing context is from this point a question of whether you want to pass around <a href="/blindsight/api/com/tersesystems/blindsight/Markers.html" title="com.tersesystems.blindsight.Markers"><code>Markers</code></a>, or pass around a <a href="/blindsight/api/com/tersesystems/blindsight/Logger.html" title="com.tersesystems.blindsight.Logger"><code>Logger</code></a>, useful for <a href="https://tersesystems.com/blog/2020/03/10/a-taxonomy-of-logging/">constructing events</a>. </p>
<h2><a href="#mapped-diagnostic-context" name="mapped-diagnostic-context" class="anchor"><span class="anchor-link"></span></a>Mapped Diagnostic Context</h2>
<p>Blindsight does not use <a href="http://logback.qos.ch/manual/mdc.html">MDC</a>, and does not recommend its use.</p>
<p>There are many reasons to not use MDC. It is inherently limiting as a <code>Map[String,String]</code>. It must be managed carefully in asynchronous programming to resolve the Map. It is mutable &ndash; it will only contain the last written values in the map at the time of logging, and no record is kept of prior values. It is static &ndash; it cannot be swapped out, enhanced, placed behind a proxy, or otherwise managed. And finally, MDC fails silently. When something goes wrong in MDC, it&rsquo;s anyone&rsquo;s guess what cleared it.</p>
<p>MDC is still useful in some circumstances. When you have third party code that already has logging, then setting variables in the MDC may be the only way of passing context to that library code: if this is the case, then you will have to manage the mapping of complex non-string data from markers to MDC by hand.</p>
<p>If there are properties in MDC that you want to use in Blindsight across an async boundary, you should pull them from MDC using <code>getCopyOfContextMap</code> and add them as structured logging properties before kicking things off:</p>
<pre class="prettyprint"><code class="language-scala">val mdcMap = MDC.getCopyOfContextMap.asJava
val loggerWithMap = logger.withMarker(bobj(mdcMap))
val resultFuture = Future {
  loggerWithMap.trace(&quot;This can be executed in different thread&quot;)
  computeThing()
}
</code></pre>
<p>Note that this is rendering markers, not revaluing MDC with a custom execution context &ndash; converters that display MDC values like <code>%X{foo}</code> won&rsquo;t work.</p>
<div class="source-github">
The source code for this page can be found <a href="https://github.com/tersesystems/blindsight/tree/v1.5.2/docs/src/main/paradox/usage/context.md">here</a>.
</div>

<div class="nav-next">
<p><strong>Next:</strong> <a href="../usage/transform.html">Entry Transformation</a></p>
</div>
</div>
<div class="large-3 show-for-large column" data-sticky-container>
<nav class="sidebar sticky" data-sticky data-anchor="docs" data-sticky-on="large">
<div class="page-nav">
<div class="nav-title">On this page:</div>
<div class="nav-toc">
<ul>
  <li><a href="../usage/context.html#contextual-logging" class="header">Contextual Logging</a>
  <ul>
    <li><a href="../usage/context.html#the-easy-way" class="header">The Easy Way</a></li>
    <li><a href="../usage/context.html#general-principles" class="header">General Principles</a></li>
    <li><a href="../usage/context.html#mapped-diagnostic-context" class="header">Mapped Diagnostic Context</a></li>
  </ul></li>
</ul>
</div>
</div>
</nav>
</div>
</div>

</section>
</div>

</div>

<footer class="site-footer">

<section class="site-footer-nav">
<div class="expanded row">
<div class="small-12 large-offset-2 large-10 column">
<div class="row site-footer-content">

<div class="small-12 medium-4 large-3 text-center column">
<div class="nav-links">
<ul>
<!-- <li><a href="https://www.example.com/products/">Products</a> -->
</ul>
</div>
</div>

</div>
</div>
</div>
</section>

<section class="site-footer-base">
<div class="expanded row">
<div class="small-12 large-offset-2 large-10 column">
<div class="row site-footer-content">

<div class="small-12 text-center large-9 column">

<!--
<div class="copyright">
<span class="text">&copy; 2021</span>
<a href="https://www.example.com" class="logo">logo</a>
</div>
-->
</div>

</div>
</div>
</div>
</section>
</footer>

</div>
</div>
</div>
</body>

<script type="text/javascript" src="../lib/foundation/dist/foundation.min.js"></script>
<script type="text/javascript">jQuery(document).foundation();</script>
<script type="text/javascript" src="../js/magellan.js"></script>

<style type="text/css">@import "../lib/prettify/prettify.css";</style>
<script type="text/javascript" src="../lib/prettify/prettify.js"></script>
<script type="text/javascript" src="../lib/prettify/lang-scala.js"></script>
<script type="text/javascript">jQuery(function(){window.prettyPrint && prettyPrint()});</script>
<script type="text/javascript">jQuery(function(jq){initOldVersionWarnings(jq, '1.5.2', 'https://tersesystems.github.io/blindsight')});</script>


</html>
